name: zmtv
on:
  schedule:
    - cron: '0 6 * * *'  # 每天 06:00 UTC 触发（对应北京时间14:00）
  push:
    branches:
      - main

# 新增权限配置：解决 workflow 创建/更新+代码推送权限问题
permissions:
  contents: write  # 允许读写仓库文件（含 y.txt 提交推送）
  workflows: write # 核心！允许创建/更新工作流文件（解决原拒绝报错）
  actions: read    # 读取 Actions 运行状态（按需配置）

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium requests eventlet

      - name: Run zmiptv
        run: python zmiptv.py

      - name: Verify file generation
        run: |
          if [ ! -f y.txt ]; then
            echo "::error::y.txt 文件未生成！"
            exit 1
          fi
          echo "文件已生成，大小：$(du -h y.txt | cut -f1)"

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "362213335lkh@gmail.com"
          git config --global user.name "l19270149853"
          git remote set-url origin https://x-access-token:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git
          git add y.txt --force
          git commit -m "强制更新 IPTV 列表 $(date +'%Y-%m-%d %H:%M') [skip ci]" --allow-empty
          git push origin main --force --force-with-lease
